# Agent Health Dashboard â€” Refined Implementation Plan

**Strategic Vision:** Leto
**Technical Refinement:** Stilgar
**Date:** 2026-02-13
**Status:** Ready for Build

---

## Vision (from Leto)

A lightweight, dependency-free health monitoring system that gives a human at-a-glance view of every agent's status. No database, no external services, no complexity. Just a markdown file that updates itself and a cron job that watches it.

The philosophy: if it requires setup beyond "copy this file and add a cron job," it's too complex.

---

## Architecture

### The Dashboard File

**Location:** `~/Documents/openclaw-docs/daily/agent-health.md`

**Why this location:**
- Already in git-tracked vault
- Accessible to all agents
- Human can open directly
- No new directory structure needed

**Template:**
```markdown
# Agent Health Dashboard

**Last Updated:** 2026-02-13T09:30:00 EST
**Version:** 1

---

## Duncan (Raven)
- **Last Ping:** 2026-02-13T09:30:00 EST
- **Model:** anthropic/claude-opus-4-6
- **Channel:** telegram
- **Status:** ðŸŸ¢ Healthy
- **Config Hash:** a1b2c3d4
- **Uptime:** 4h 23m

## Leto (Lion)
- **Last Ping:** 2026-02-13T09:28:00 EST
- **Model:** openrouter/minimax/minimax-m2.5
- **Channel:** telegram
- **Status:** ðŸŸ¢ Healthy
- **Config Hash:** e5f6g7h8
- **Uptime:** 4h 21m

## Stilgar (Bear)
- **Last Ping:** 2026-02-13T09:25:00 EST
- **Model:** zai/glm-4.7
- **Channel:** telegram
- **Status:** ðŸŸ¢ Healthy
- **Config Hash:** i9j0k1l2
- **Uptime:** 4h 18m

---

## Status Legend
- ðŸŸ¢ Healthy â€” Last ping < 30 min
- ðŸŸ¡ Warning â€” Last ping 30-60 min
- ðŸ”´ Critical â€” Last ping > 60 min
- âšª Unknown â€” No data

---

*Auto-generated by agent heartbeats. Do not edit manually.*
*Monitoring cron checks every 15 min.*
```

---

### Agent Reporting Protocol

**Update mechanism:** Agent reads full file, replaces own section, writes back.

**Why read-full-and-replace vs append:**
- Prevents drift (each update resets the whole section)
- Handles missing sections (adds if not found)
- Simpler than partial regex replacement

**Update script (for heartbeat hook):**

```bash
#!/bin/bash
# update-health-dashboard.sh
# Called by each agent on heartbeat

AGENT_NAME="$1"  # e.g., "Stilgar"
DASHBOARD_PATH="$HOME/Documents/openclaw-docs/daily/agent-health.md"

# Get current state
CURRENT_MODEL=$(openclaw status --json | jq -r '.model')
CURRENT_CHANNEL=$(openclaw status --json | jq -r '.channel')
CURRENT_CONFIG_HASH=$(openclaw gateway config.get --raw | shasum -a 256 | cut -d' ' -f1 | cut -c1-8)
CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S EST")

# Calculate uptime (read from uptime file or default to 0)
UPTIME_FILE="/tmp/${AGENT_NAME}-uptime-start"
if [ ! -f "$UPTIME_FILE" ]; then
    date +%s > "$UPTIME_FILE"
fi
START_TIME=$(cat "$UPTIME_FILE")
CURRENT_EPOCH=$(date +%s)
UPTIME_SECONDS=$((CURRENT_EPOCH - START_TIME))
UPTIME_HUMAN=$(printf '%dh %dm' $((UPTIME_SECONDS/3600)) $((UPTIME_SECONDS%3600/60)))

# Determine status emoji
STATUS_EMOJI="ðŸŸ¢"  # Will be overwritten by monitoring cron

# Build section
SECTION="## ${AGENT_NAME} (${AGENT_CREATURE})
- **Last Ping:** ${CURRENT_TIME}
- **Model:** ${CURRENT_MODEL}
- **Channel:** ${CURRENT_CHANNEL}
- **Status:** ${STATUS_EMOJI} Healthy
- **Config Hash:** ${CURRENT_CONFIG_HASH}
- **Uptime:** ${UPTIME_HUMAN}"

# Read current dashboard
if [ -f "$DASHBOARD_PATH" ]; then
    DASHBOARD_CONTENT=$(cat "$DASHBOARD_PATH")
else
    # Create from template
    DASHBOARD_CONTENT="# Agent Health Dashboard

**Last Updated:** ${CURRENT_TIME}
**Version:** 1

---

[PLACEHOLDER]

---

## Status Legend
- ðŸŸ¢ Healthy â€” Last ping < 30 min
- ðŸŸ¡ Warning â€” Last ping 30-60 min
- ðŸ”´ Critical â€” Last ping > 60 min
- âšª Unknown â€” No data

---

*Auto-generated by agent heartbeats. Do not edit manually.*
*Monitoring cron checks every 15 min.*"
fi

# Replace own section (or add if not found)
if echo "$DASHBOARD_CONTENT" | grep -q "## ${AGENT_NAME} "; then
    # Section exists, replace it
    UPDATED_CONTENT=$(echo "$DASHBOARD_CONTENT" | awk -v section="$SECTION" -v agent="$AGENT_NAME" '
        $0 ~ "## " agent " " { print section; next }
        { print }
    ')
else
    # Section doesn't exist, add it after the header
    UPDATED_CONTENT=$(echo "$DASHBOARD_CONTENT" | awk -v section="$SECTION" '
        /^---$/ && !found { print; print ""; print section; print ""; found=1; next }
        { print }
    ')
fi

# Update last-updated timestamp
UPDATED_CONTENT=$(echo "$UPDATED_CONTENT" | sed "s/\*\*Last Updated:\*\* .*/\*\*Last Updated:\*\* ${CURRENT_TIME}/")

# Write back (atomic)
echo "$UPDATED_CONTENT" > "${DASHBOARD_PATH}.tmp"
mv "${DASHBOARD_PATH}.tmp" "$DASHBOARD_PATH"
```

**Hook integration:**
Add to each agent's heartbeat hook:
```bash
# At end of heartbeat processing:
~/scripts/update-health-dashboard.sh "Stilgar" "Bear"
```

---

### Race Condition Handling

**Problem:** Two agents updating simultaneously could cause lost updates.

**Solution: File locking (simple approach)**

```bash
LOCK_FILE="/tmp/agent-health-dashboard.lock"

# Acquire lock (timeout 10s)
if ! flock -n 10; then
    echo "Could not acquire lock, skipping update"
    exit 0
fi

# ... perform update ...

# Release lock automatically on exit
```

**Update script with locking:**
```bash
(
    flock -w 10 200 || exit 0

    # Read, modify, write logic here

) 200>"$LOCK_FILE"
```

**Why this works:**
- `flock` is standard on macOS/Linux
- Non-blocking with timeout (won't hang heartbeat)
- Lock released automatically when script exits
- Rare collision = one agent skips update (no data loss, just delayed)

---

### Monitoring Cron

**Cron schedule:** Every 15 minutes

**Cron entry:**
```
*/15 * * * * ~/scripts/check-agent-health.sh
```

**check-agent-health.sh:**
```bash
#!/bin/bash
DASHBOARD_PATH="$HOME/Documents/openclaw-docs/daily/agent-health.md"
ALERT_FILE="/tmp/agent-health-last-alert"

# Get current time
CURRENT_EPOCH=$(date +%s)

# Parse each agent's last ping
declare -A AGENTS
AGENTS["Duncan"]=0
AGENTS["Leto"]=0
AGENTS["Stilgar"]=0

# Read dashboard and extract timestamps
while IFS= read -r line; do
    if [[ $line =~ ^##\ ([A-Za-z]+)\ ]]; then
        CURRENT_AGENT="${BASH_REMATCH[1]}"
    fi
    if [[ $line =~ \*\*Last\ Ping:\*\*\ ([0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}) ]]; then
        TIMESTAMP="${BASH_REMATCH[1]}"
        PING_EPOCH=$(date -j -f "%Y-%m-%dT%H:%M:%S" "$TIMESTAMP" +%s 2>/dev/null || echo "0")
        AGENTS["$CURRENT_AGENT"]="$PING_EPOCH"
    fi
done < "$DASHBOARD_PATH"

# Check each agent
ALERT_MESSAGES=()
CRITICAL_AGENTS=()

for AGENT in "${!AGENTS[@]}"; do
    PING_EPOCH="${AGENTS[$AGENT]}"
    if [ "$PING_EPOCH" -eq 0 ]; then
        ALERT_MESSAGES+=("âšª $AGENT: Unknown (no data)")
        continue
    fi

    STALE_SECONDS=$((CURRENT_EPOCH - PING_EPOCH))
    STALE_MINUTES=$((STALE_SECONDS / 60))

    if [ "$STALE_MINUTES" -gt 60 ]; then
        ALERT_MESSAGES+=("ðŸ”´ $AGENT: Critical ($STALE_MINUTES min since last ping)")
        CRITICAL_AGENTS+=("$AGENT")
    elif [ "$STALE_MINUTES" -gt 30 ]; then
        ALERT_MESSAGES+=("ðŸŸ¡ $AGENT: Warning ($STALE_MINUTES min since last ping)")
    fi
done

# Update status emojis in dashboard
# (Implementation: re-read, update Status: lines based on staleness)

# Send alert if needed
if [ ${#ALERT_MESSAGES[@]} -gt 0 ]; then
    # Check if we already alerted recently (debounce 30 min)
    if [ -f "$ALERT_FILE" ]; then
        LAST_ALERT=$(cat "$ALERT_FILE")
        if [ $((CURRENT_EPOCH - LAST_ALERT)) -lt 1800 ]; then
            exit 0  # Already alerted recently
        fi
    fi

    # Build alert message
    MESSAGE="âš ï¸ Agent Health Alert

${ALERT_MESSAGES[*]}

Dashboard: ~/Documents/openclaw-docs/daily/agent-health.md
Time: $(date '+%Y-%m-%d %H:%M EST')"

    # Send via message tool (or openclaw gateway wake)
    echo "$MESSAGE" | openclaw message send --to "Sean" --channel telegram

    # Record alert time
    echo "$CURRENT_EPOCH" > "$ALERT_FILE"

    # If critical, also notify Duncan
    if [ ${#CRITICAL_AGENTS[@]} -gt 0 ]; then
        echo "CRITICAL: ${CRITICAL_AGENTS[*]} unresponsive" | \
            openclaw message send --to "Duncan" --channel telegram
    fi
fi
```

---

### Config Hash Implementation

**How to compute:**
```bash
CURRENT_CONFIG_HASH=$(openclaw gateway config.get --raw | shasum -a 256 | cut -d' ' -f1 | cut -c1-8)
```

**Why first 8 characters:**
- Full SHA-256 is 64 chars, too long for dashboard
- 8 hex chars = 32 bits = 4 billion combinations
- Collision unlikely for our purposes
- Short enough to see at a glance

**What it tells us:**
- If hash changes, config was patched
- If hash same, config stable
- Useful for correlating issues with config changes

---

### Status Emoji Logic

The monitoring cron updates status emojis in the dashboard:

| Condition | Status | Emoji |
|-----------|--------|-------|
| Last ping < 30 min | Healthy | ðŸŸ¢ |
| Last ping 30-60 min | Warning | ðŸŸ¡ |
| Last ping > 60 min | Critical | ðŸ”´ |
| No data / parse error | Unknown | âšª |

**Emoji update (in check-agent-health.sh):**
```bash
# After determining staleness, update dashboard
if [ "$STALE_MINUTES" -gt 60 ]; then
    EMOJI="ðŸ”´"
    STATUS="Critical"
elif [ "$STALE_MINUTES" -gt 30 ]; then
    EMOJI="ðŸŸ¡"
    STATUS="Warning"
else
    EMOJI="ðŸŸ¢"
    STATUS="Healthy"
fi

# Update the agent's status line
sed -i '' "s/## ${AGENT}.*Status: .*/## ${AGENT} (...)\n- **Status:** ${EMOJI} ${STATUS}/" "$DASHBOARD_PATH"
```

---

## Open Questions â€” Answered

### Q1: Race condition â€” two agents writing simultaneously?

**Answer:** Use `flock` for file locking. Simple, standard, no dependencies.

```bash
flock -w 10 /tmp/agent-health-dashboard.lock your-script.sh
```

If lock unavailable, skip update (no data loss, just delayed by one heartbeat).

### Q2: Uptime or last ping?

**Answer:** Both.

- Last ping tells you recency
- Uptime tells you stability
- Both fit in the section without bloat

Uptime calculated from a start-time file written on first heartbeat.

### Q3: Previous N pings for trend analysis?

**Answer:** Not in v1. Keep it simple.

Future enhancement: `agent-health-history.log` with one line per ping:
```
2026-02-13T09:30:00 Stilgar glm-4.7 healthy
```

But that's v2. MVP is single-file current state.

### Q4: Config hash implementation?

**Answer:** `config.get --raw | shasum -a 256 | cut -c1-8`

8-character prefix is enough for change detection without cluttering dashboard.

---

## Edge Cases

| Scenario | Behavior |
|----------|----------|
| Dashboard file doesn't exist | Agent creates it from template |
| Agent section missing | Agent adds its section |
| Malformed timestamp | Treat as Unknown (âšª) |
| Dashboard corrupted | Monitoring cron alerts + suggest manual fix |
| Agent comes back online | Status auto-updates to ðŸŸ¢ on next ping |
| Multiple agents stale | Single alert lists all affected agents |
| Alert already sent recently | Debounce 30 min to avoid spam |
| Config hash changes | Visible in dashboard, no automatic action |

---

## Implementation Checklist

**Phase 1: Dashboard File**
- [ ] Create template at `~/Documents/openclaw-docs/daily/agent-health.md`
- [ ] Test manual edits, verify format

**Phase 2: Agent Update Script**
- [ ] Write `update-health-dashboard.sh`
- [ ] Add flock locking
- [ ] Test with single agent

**Phase 3: Hook Integration**
- [ ] Add to each agent's heartbeat hook
- [ ] Test with all agents

**Phase 4: Monitoring Cron**
- [ ] Write `check-agent-health.sh`
- [ ] Add cron entry
- [ ] Test stale detection
- [ ] Test alerting

**Phase 5: Polish**
- [ ] Status emoji auto-update
- [ ] Alert debounce logic
- [ ] Critical escalation

---

## File Structure

```
~/Documents/openclaw-docs/
  daily/
    agent-health.md           # Dashboard

~/scripts/
  update-health-dashboard.sh  # Agent heartbeat hook
  check-agent-health.sh       # Monitoring cron

/tmp/
  Duncan-uptime-start         # Uptime tracking files
  Leto-uptime-start
  Stilgar-uptime-start
  agent-health-dashboard.lock # Lock file
  agent-health-last-alert     # Debounce timestamp
```

---

## Success Criteria

- [ ] Every agent updates own section on heartbeat
- [ ] Dashboard readable in < 5 seconds
- [ ] Cron detects stale agent within 15 min
- [ ] Alert fires correctly on stale agent
- [ ] Git history shows meaningful change log
- [ ] No alert spam (debounce works)
- [ ] Race conditions handled gracefully

---

**Ready to build. Estimate: 1-2 hours for full implementation.**

ðŸ»
